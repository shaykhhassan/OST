#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "Usage: $0 <cleaned_tsv_file>" >&2
    exit 1
fi

file="$1"

# Columns to test: year(3), users rated(8), rating avg(9), complexity(11), owned users(12)
# Print header
echo "Correlation between column pairs:"

pairs=(
    "3 9"   # Year Published vs Rating Average
    "8 9"   # Users Rated vs Rating Average
    "11 9"  # Complexity vs Rating Average
    "12 8"  # Owned Users vs Users Rated
)

for pair in "${pairs[@]}"; do
    awk -v c1=$(echo $pair | cut -d' ' -f1) -v c2=$(echo $pair | cut -d' ' -f2) '
    BEGIN {
        sum_x = sum_y = sum_xy = sum_x2 = sum_y2 = 0
        n = 0
    }
    NR == 1 { next }  # Skip header

    {
        x = $c1 + 0
        y = $c2 + 0

        sum_x += x
        sum_y += y
        sum_xy += x * y
        sum_x2 += x * x
        sum_y2 += y * y
        n++
    }

    END {
        numerator = n * sum_xy - sum_x * sum_y
        denom = sqrt((n * sum_x2 - sum_x^2) * (n * sum_y2 - sum_y^2))

        if (denom == 0) {
            print "Columns", c1, "and", c2, ": correlation undefined"
        } else {
            r = numerator / denom
            printf("Columns %d and %d: r = %.4f\n", c1, c2, r)
        }
    }
    ' "$file"
done
